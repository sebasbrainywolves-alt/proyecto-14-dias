<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación Ikigai - Proceso C</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración Global
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ikigai-kaizen-v4';
        
        window.localState = {
            currentDay: 1,
            completedDays: [],
            reflections: [],
            taskStates: [],
            ikigaiNotes: { love: "", need: "", paid: "", good: "" }
        };

        let db = null, auth = null, currentUser = null;

        const loadFromLocalStorage = () => {
            const saved = localStorage.getItem(`ikigai_v4_${appId}`);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    window.localState = { ...window.localState, ...parsed };
                    syncTasksWithState();
                } catch (e) { console.error("Error localStorage", e); }
            }
        };

        const syncTasksWithState = () => {
            if (window.localState.taskStates && Array.isArray(window.localState.taskStates)) {
                window.localState.taskStates.forEach((dayTasks, dIdx) => {
                    if (window.plan && window.plan[dIdx] && Array.isArray(dayTasks)) {
                        dayTasks.forEach((taskData, tIdx) => {
                            if (window.plan[dIdx].tasks[tIdx]) {
                                if (typeof taskData === 'object' && taskData.steps) {
                                    window.plan[dIdx].tasks[tIdx].steps.forEach((step, sIdx) => {
                                        if (taskData.steps[sIdx] !== undefined) step.done = taskData.steps[sIdx];
                                    });
                                    window.plan[dIdx].tasks[tIdx].done = taskData.done;
                                }
                            }
                        });
                    }
                });
            }
        };

        const initFirebase = async () => {
            loadFromLocalStorage(); 
            window.updateUI();
            window.renderReflections();

            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                    } else { 
                        await signInAnonymously(auth); 
                    }

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                            document.getElementById('userIdDisplay').innerText = `ID: ${user.uid}`;
                            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'mainState');
                            onSnapshot(docRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    let data = docSnap.data();
                                    if (data.taskStates && typeof data.taskStates === 'string') {
                                        data.taskStates = JSON.parse(data.taskStates);
                                    }
                                    window.localState = { ...window.localState, ...data };
                                    syncTasksWithState();
                                    window.updateUI();
                                    window.renderReflections();
                                    updateIkigaiFields();
                                }
                            });
                        }
                        document.getElementById('loadingOverlay').style.display = 'none';
                    });
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            } catch (err) { 
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };

        const updateIkigaiFields = () => {
            const notes = window.localState.ikigaiNotes || {};
            if(document.getElementById('noteLove')) document.getElementById('noteLove').value = notes.love || "";
            if(document.getElementById('noteNeed')) document.getElementById('noteNeed').value = notes.need || "";
            if(document.getElementById('notePaid')) document.getElementById('notePaid').value = notes.paid || "";
            if(document.getElementById('noteGood')) document.getElementById('noteGood').value = notes.good || "";
        };

        window.saveData = async () => {
            const states = window.plan.map(p => p.tasks.map(t => ({
                done: t.done,
                steps: t.steps.map(s => s.done)
            })));
            window.localState.taskStates = states;
            
            window.localState.ikigaiNotes = {
                love: document.getElementById('noteLove')?.value || "",
                need: document.getElementById('noteNeed')?.value || "",
                paid: document.getElementById('notePaid')?.value || "",
                good: document.getElementById('noteGood')?.value || ""
            };

            localStorage.setItem(`ikigai_v4_${appId}`, JSON.stringify(window.localState));
            
            if (currentUser && db) {
                const dataToSave = { 
                    ...window.localState, 
                    taskStates: JSON.stringify(states),
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'progress', 'mainState'), dataToSave);
            }
        };

        window.addEventListener('load', initFirebase);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --bg: #0b1120; --card: #161e31; --accent: #38bdf8; --success: #10b981; }
        body { background-color: var(--bg); color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass-card { background: var(--card); border: 1px solid #1e293b; }
        .day-box { aspect-ratio: 1/1; border-radius: 12px; border: 1px solid #1e293b; cursor: pointer; transition: all 0.2s; min-width: 40px; }
        .day-box.completed { border-color: var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .day-box.current { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); transform: scale(1.05); }
        .task-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .task-card.done { border-left-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .step-item { cursor: pointer; transition: all 0.2s; }
        .step-item.checked { color: var(--success); text-decoration: line-through; opacity: 0.6; }
        .ikigai-input { background: transparent; border: none; border-bottom: 1px solid #1e293b; width: 100%; font-size: 10px; color: #94a3b8; outline: none; }
        .ikigai-input:focus { border-color: var(--accent); color: white; }
        
        /* Modal Style */
        .modal-backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        #reportOutput { color: #1e293b; }
        .report-label { font-size: 8px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; }
    </style>
</head>
<body class="min-h-screen pb-20 p-4 md:p-8">

    <div id="loadingOverlay" class="fixed inset-0 bg-[#0b1120] z-50 flex items-center justify-center text-center">
        <div>
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-sky-500 mb-4 mx-auto"></div>
            <p class="text-[10px] font-bold tracking-widest text-slate-500 uppercase">Sincronizando Sistema de Control...</p>
        </div>
    </div>

    <!-- Modal Reporte -->
    <div id="reportModal" class="fixed inset-0 z-[100] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-hidden shadow-2xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-slate-800 font-black italic uppercase text-sm tracking-tighter">Reporte Integral Ikigai-Kaizen</h3>
                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="bg-slate-200 hover:bg-slate-300 text-slate-600 p-2 rounded-full px-4 text-[10px] font-bold uppercase transition-all">Cerrar</button>
            </div>
            <div id="reportContent" class="overflow-y-auto p-8 md:p-12 bg-white text-slate-800">
                <!-- El contenido se genera via JS -->
            </div>
            <div class="p-4 bg-slate-50 border-t text-center">
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Documento de uso profesional generado por Estación Ikigai</p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">ESTACIÓN <span class="text-sky-400">IKIGAI</span></h1>
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">PROCESO C - REPORTE DE RESULTADOS</p>
            </div>
            <div id="userIdDisplay" class="text-[8px] font-mono text-slate-600 bg-slate-900 px-3 py-1 rounded-full uppercase">ID: ---</div>
        </header>

        <!-- Pilares -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card rounded-2xl p-4 border-t-4 border-pink-500/50">
                <h4 class="text-[9px] font-black uppercase text-pink-400 mb-2">Lo que amas</h4>
                <textarea id="noteLove" onblur="window.saveData()" class="ikigai-input h-12 resize-none" placeholder="Escribe aquí..."></textarea>
            </div>
            <div class="glass-card rounded-2xl p-4 border-t-4 border-indigo-500/50">
                <h4 class="text-[9px] font-black uppercase text-indigo-400 mb-2">El mundo necesita</h4>
                <textarea id="noteNeed" onblur="window.saveData()" class="ikigai-input h-12 resize-none" placeholder="Escribe aquí..."></textarea>
            </div>
            <div class="glass-card rounded-2xl p-4 border-t-4 border-emerald-500/50">
                <h4 class="text-[9px] font-black uppercase text-emerald-400 mb-2">Por lo que te pagan</h4>
                <textarea id="notePaid" onblur="window.saveData()" class="ikigai-input h-12 resize-none" placeholder="Escribe aquí..."></textarea>
            </div>
            <div class="glass-card rounded-2xl p-4 border-t-4 border-amber-500/50">
                <h4 class="text-[9px] font-black uppercase text-amber-400 mb-2">Eres bueno en</h4>
                <textarea id="noteGood" onblur="window.saveData()" class="ikigai-input h-12 resize-none" placeholder="Escribe aquí..."></textarea>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="glass-card rounded-2xl p-4 text-center">
                <div class="text-[8px] font-bold text-slate-500 uppercase mb-1">Estabilidad</div>
                <div id="percEst" class="text-2xl font-black text-sky-400">0%</div>
            </div>
            <div class="glass-card rounded-2xl p-4 text-center">
                <div class="text-[8px] font-bold text-slate-500 uppercase mb-1">Flujo</div>
                <div id="percFlu" class="text-2xl font-black text-amber-400">0%</div>
            </div>
            <div class="glass-card rounded-2xl p-4 text-center">
                <div class="text-[8px] font-bold text-slate-500 uppercase mb-1">Sentido</div>
                <div id="percSen" class="text-2xl font-black text-emerald-400">0%</div>
            </div>
        </div>

        <div id="calendarGrid" class="grid grid-cols-7 lg:grid-cols-14 gap-2 mb-8"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-end mb-2">
                    <h2 id="dayTitle" class="text-3xl font-black italic">Día 1</h2>
                    <span id="dailyCount" class="text-sm font-bold text-slate-500 bg-slate-800 px-3 py-1 rounded-lg">0 / 9</span>
                </div>
                <div id="taskList" class="space-y-4"></div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.cerrarDia()" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-black py-4 rounded-xl transition-all uppercase text-[10px] tracking-widest italic active:scale-[0.98]">Cerrar Día</button>
                    <button onclick="window.generarReporte()" class="w-full bg-white text-black hover:bg-slate-200 font-black py-4 rounded-xl transition-all uppercase text-[10px] tracking-widest italic active:scale-[0.98] border border-white">Generar Reporte Integral</button>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-card rounded-2xl p-6">
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">Bitácora Kaizen</h3>
                    <textarea id="reflexionInput" class="w-full bg-slate-900 border border-slate-800 rounded-lg p-3 text-xs mb-3 focus:ring-1 focus:ring-sky-500 outline-none text-slate-300" rows="3" placeholder="Hallazgos..."></textarea>
                    <button onclick="window.guardarReflexion()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-black p-2 rounded-lg text-[10px] uppercase">Registrar</button>
                    <div id="historyLog" class="mt-4 space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const rawPlan = [
            { day: 1, tasks: [
                { concept: "Estabilidad", title: "Carpeta Digital Master", desc: "Estructura Drive.", steps: ["Crear carpetas", "Configurar permisos", "Revisar nomenclatura"] },
                { concept: "Flujo", title: "Registro Sebastián", desc: "Obtener copia digital.", steps: ["Solicitar archivos", "Verificar versiones", "Guardar copia"] },
                { concept: "Sentido", title: "Foto: Luz Natural", desc: "Capturar potencial.", steps: ["Elegir espacio", "Ajustar ángulos", "Tomar 3 fotos"] }
            ]},
            { day: 2, tasks: [
                { concept: "Estabilidad", title: "Registro Ana", desc: "Escanear y centralizar.", steps: ["Escanear documentos", "Revisar calidad", "Subir a Drive"] },
                { concept: "Flujo", title: "Preparación Cota", desc: "Identificar grietas.", steps: ["Revisar casa", "Marcar grietas", "Fotos referencia"] },
                { concept: "Sentido", title: "Foto: Textura", desc: "Capturar material bruto.", steps: ["Elegir material", "Luz adecuada", "Fotos detalle"] }
            ]},
            { day: 3, tasks: [
                { concept: "Estabilidad", title: "Migración Digital", desc: "Nombrar archivos.", steps: ["Revisar existentes", "Aplicar estándar", "Limpiar carpetas"] },
                { concept: "Flujo", title: "Seguimiento Legal", desc: "Correo estatus.", steps: ["Verificar correo", "Redactar seguimiento", "Registrar respuesta"] },
                { concept: "Sentido", title: "Dibujo de Observación", desc: "Esbozar rincón.", steps: ["Elegir rincón", "Boceto rápido", "Nota de inspiración"] }
            ]},
            { day: 4, tasks: [
                { concept: "Estabilidad", title: "Finalizar Resane", desc: "Segunda capa estuco.", steps: ["Mezcla uniforme", "Aplicación capa", "Revisión secado"] },
                { concept: "Flujo", title: "Inventario Táctico", desc: "Listar pinturas.", steps: ["Revisar latas", "Clasificar colores", "Digitalizar stock"] },
                { concept: "Sentido", title: "Registro 'Antes'", desc: "Foto panorámica.", steps: ["Ángulo amplio", "Luz uniforme", "Guardar referencia"] }
            ]},
            { day: 5, tasks: [
                { concept: "Estabilidad", title: "Medición de Vidrios", desc: "Dimensiones cerramiento.", steps: ["Tomar medidas", "Dibujar croquis", "Confirmar cantidades"] },
                { concept: "Flujo", title: "Orden de Herramientas", desc: "Clasificar taller.", steps: ["Organizar cajas", "Limpiar equipos", "Actualizar lista"] },
                { concept: "Sentido", title: "Composición Ikigai", desc: "3 objetos cotidianos.", steps: ["Seleccionar objetos", "Foto composición", "Nota significado"] }
            ]},
            { day: 6, tasks: [
                { concept: "Estabilidad", title: "Impermeabilización", desc: "Sellar humedad.", steps: ["Identificar focos", "Aplicar producto", "Verificar sello"] },
                { concept: "Flujo", title: "Validación Agenda", desc: "Citas técnicos.", steps: ["Revisar citas", "Confirmar horarios", "Actualizar equipo"] },
                { concept: "Sentido", title: "Foto de Manos", desc: "Orgullo manual.", steps: ["Capturar trabajo", "Encuadre manos", "Guardar archivo"] }
            ]},
            { day: 7, tasks: [
                { concept: "Estabilidad", title: "Base de Color", desc: "Primera mano pintura.", steps: ["Preparar pared", "Aplicar base", "Limpiar bordes"] },
                { concept: "Flujo", title: "Limpieza Operativa", desc: "Retirar escombros.", steps: ["Despejar área", "Bolsas de residuo", "Aspirar polvo"] },
                { concept: "Sentido", title: "Bitácora de Cambio", desc: "Relato nuevo color.", steps: ["Nota reflexión", "Foto avance", "Registrar color"] }
            ]},
            { day: 8, tasks: [
                { concept: "Estabilidad", title: "Acabado Uniforme", desc: "Segunda mano pintura.", steps: ["Aplicar color final", "Retocar esquinas", "Verificar secado"] },
                { concept: "Flujo", title: "Auditoría Legal II", desc: "Verificar respuesta.", steps: ["Verificar documento", "Registrar estatus", "Archivar"] },
                { concept: "Sentido", title: "Trazos Libres", desc: "10 min dibujo.", steps: ["Boceto libre", "Nota creativa", "Guardar dibujo"] }
            ]},
            { day: 9, tasks: [
                { concept: "Estabilidad", title: "Retiro de Protecciones", desc: "Revelar estructura.", steps: ["Retirar cintas", "Quitar plásticos", "Limpiar vidrios"] },
                { concept: "Flujo", title: "Curaduría Visual", desc: "Elegir fotos avance.", steps: ["Seleccionar 5 fotos", "Editar básico", "Organizar Drive"] },
                { concept: "Sentido", title: "Foto 'Después'", desc: "Resultado logrado.", steps: ["Mismo ángulo 'Antes'", "Luz idéntica", "Comparativa"] }
            ]},
            { day: 10, tasks: [
                { concept: "Estabilidad", title: "Borrador de Oferta", desc: "Términos arriendo.", steps: ["Definir canon", "Redactar cláusulas", "Revisión final"] },
                { concept: "Flujo", title: "Estudio de Mercado", desc: "Comparar precios.", steps: ["Revisar portales", "Tabla comparativa", "Margen proyectado"] },
                { concept: "Sentido", title: "Captura de Ambiente", desc: "Detalle invitador.", steps: ["Foto detalle", "Nota atmósfera", "Guardar archivo"] }
            ]},
            { day: 11, tasks: [
                { concept: "Estabilidad", title: "Publicación Oficial", desc: "Subir portales.", steps: ["Subir fotos", "Redactar texto", "Pagar destaque"] },
                { concept: "Flujo", title: "Atención Táctica", desc: "Respuestas prospectos.", steps: ["Responder leads", "Agendar visitas", "Registrar interesados"] },
                { concept: "Sentido", title: "Dibujo de Habitante", desc: "Inquilino ideal.", steps: ["Boceto perfil", "Reflexión humana", "Guardar nota"] }
            ]},
            { day: 12, tasks: [
                { concept: "Estabilidad", title: "Presión Legal", desc: "Llamada directa.", steps: ["Llamar despacho", "Estatus tutela", "Registrar avance"] },
                { concept: "Flujo", title: "Cierre de Gastos", desc: "Inversión real.", steps: ["Sumar facturas", "Balance final", "Nota rentabilidad"] },
                { concept: "Sentido", title: "Foto: Apertura", desc: "Ventana abierta.", steps: ["Foto encuadre", "Nota de luz", "Guardar registro"] }
            ]},
            { day: 13, tasks: [
                { concept: "Estabilidad", title: "Segunda Opinión", desc: "Alternativa externa.", steps: ["Cita profesional", "Hacer consulta", "Anotar conclusión"] },
                { concept: "Flujo", title: "Matriz de Interés", desc: "Comparar candidatos.", steps: ["Revisar perfiles", "Elegir top 3", "Llamar finalistas"] },
                { concept: "Sentido", title: "Círculo Enso", desc: "Zen del proyecto.", steps: ["Dibujo círculo", "Reflexión cierre", "Guardar dibujo"] }
            ]},
            { day: 14, tasks: [
                { concept: "Estabilidad", title: "Auditoría de Bloques", desc: "Revisar tareas.", steps: ["Check 14 días", "Identificar fallas", "Nota mejora"] },
                { concept: "Flujo", title: "Plan Siguiente Ciclo", desc: "Diseñar próximos días.", steps: ["Elegir objetivos", "Calendario nuevo", "Registrar plan"] },
                { concept: "Sentido", title: "Foto: Gratitud", desc: "Detalle sonrisa.", steps: ["Foto momento", "Nota de cierre", "Guardar final"] }
            ]}
        ];

        window.plan = rawPlan.map(d => ({
            ...d,
            tasks: d.tasks.map(t => ({
                ...t, done: false,
                steps: t.steps.map(s => ({ text: s, done: false }))
            }))
        }));

        let radarChart = null;

        window.toggleStep = (dayIdx, taskIdx, stepIdx) => {
            const task = window.plan[dayIdx].tasks[taskIdx];
            task.steps[stepIdx].done = !task.steps[stepIdx].done;
            task.done = task.steps.every(s => s.done);
            window.updateUI();
            window.saveData();
        };

        window.updateUI = () => {
            const dayIdx = window.localState.currentDay - 1;
            const currentPlan = window.plan[dayIdx];
            document.getElementById('dayTitle').innerText = `Día ${currentPlan.day}`;
            
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            let tSteps = 0, cSteps = 0;

            currentPlan.tasks.forEach((t, i) => {
                const card = document.createElement('div');
                card.className = `task-card glass-card rounded-2xl p-4 md:p-5 ${t.done ? 'done' : ''}`;
                
                let sHtml = '';
                t.steps.forEach((s, si) => {
                    tSteps++; if(s.done) cSteps++;
                    sHtml += `
                        <div onclick="window.toggleStep(${dayIdx}, ${i}, ${si})" class="step-item flex items-center p-2 rounded-lg ${s.done ? 'checked' : 'text-slate-400'}">
                            <div class="w-4 h-4 rounded border border-slate-700 mr-3 flex items-center justify-center transition-all ${s.done ? 'bg-emerald-500 border-emerald-500' : 'bg-slate-900'}">
                                ${s.done ? '<span class="text-white text-[8px]">✓</span>' : ''}
                            </div>
                            <span class="text-[9px] font-bold uppercase tracking-tight">${s.text}</span>
                        </div>`;
                });

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[8px] font-black uppercase text-sky-400">${t.concept}</span>
                            <h4 class="text-sm font-bold text-white mt-1">${t.title}</h4>
                        </div>
                        <div class="text-[9px] font-mono text-slate-500">${t.steps.filter(s => s.done).length}/${t.steps.length}</div>
                    </div>
                    <div class="grid grid-cols-1 gap-1 border-t border-slate-800 pt-3 mt-1">${sHtml}</div>`;
                taskList.appendChild(card);
            });

            document.getElementById('dailyCount').innerText = `${cSteps} / ${tSteps}`;

            let eT=0, eD=0, fT=0, fD=0, sT=0, sD=0;
            window.plan.forEach(d => d.tasks.forEach(t => {
                t.steps.forEach(s => {
                    if(t.concept === "Estabilidad") { eT++; if(s.done) eD++; }
                    if(t.concept === "Flujo") { fT++; if(s.done) fD++; }
                    if(t.concept === "Sentido") { sT++; if(s.done) sD++; }
                });
            }));

            const pE = Math.round((eD/eT)*100) || 0;
            const pF = Math.round((fD/fT)*100) || 0;
            const pS = Math.round((sD/sT)*100) || 0;
            
            document.getElementById('percEst').innerText = pE + "%";
            document.getElementById('percFlu').innerText = pF + "%";
            document.getElementById('percSen').innerText = pS + "%";
            
            if(radarChart) {
                radarChart.data.datasets[0].data = [pE, pF, pS];
                radarChart.update();
            }

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            for(let i=1; i<=14; i++) {
                const div = document.createElement('div');
                const isDone = window.localState.completedDays.includes(i);
                div.className = `day-box flex items-center justify-center text-[10px] font-black ${i === window.localState.currentDay ? 'current' : ''} ${isDone ? 'completed' : ''}`;
                div.innerText = i;
                div.onclick = () => { window.localState.currentDay = i; window.updateUI(); };
                grid.appendChild(div);
            }
        };

        window.cerrarDia = () => {
            if(!window.localState.completedDays.includes(window.localState.currentDay)) {
                window.localState.completedDays.push(window.localState.currentDay);
            }
            if(window.localState.currentDay < 14) window.localState.currentDay++;
            window.updateUI();
            window.saveData();
        };

        window.guardarReflexion = () => {
            const val = document.getElementById('reflexionInput').value;
            if(!val.trim()) return;
            window.localState.reflections.push({ day: window.localState.currentDay, text: val, ts: new Date().toLocaleTimeString() });
            document.getElementById('reflexionInput').value = '';
            window.renderReflections();
            window.saveData();
        };

        window.renderReflections = () => {
            const log = document.getElementById('historyLog');
            log.innerHTML = '';
            [...window.localState.reflections].reverse().forEach(r => {
                log.innerHTML += `
                    <div class="text-[9px] p-2 bg-slate-800/40 rounded-lg border border-slate-700/50 mb-2">
                        <div class="flex justify-between text-slate-500 mb-1 font-bold"><span>DÍA ${r.day}</span><span>${r.ts}</span></div>
                        <p class="text-slate-300">${r.text}</p>
                    </div>`;
            });
        };

        window.generarReporte = () => {
            const container = document.getElementById('reportContent');
            const now = new Date();
            
            // Calculos globales
            let eT=0, eD=0, fT=0, fD=0, sT=0, sD=0;
            window.plan.forEach(d => d.tasks.forEach(t => {
                t.steps.forEach(s => {
                    if(t.concept === "Estabilidad") { eT++; if(s.done) eD++; }
                    if(t.concept === "Flujo") { fT++; if(s.done) fD++; }
                    if(t.concept === "Sentido") { sT++; if(s.done) sD++; }
                });
            }));
            const avg = Math.round(((eD+fD+sD)/(eT+fT+sT))*100) || 0;

            let html = `
                <div class="space-y-8">
                    <div class="flex justify-between border-b pb-4 items-center">
                        <div class="text-xs font-black uppercase tracking-tighter italic">Estación Ikigai <span class="text-sky-500">v4.0</span></div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Generado: ${now.toLocaleString()}</div>
                    </div>

                    <div class="text-center py-6">
                        <h1 class="text-5xl font-black italic uppercase tracking-tighter mb-2">${avg}%</h1>
                        <p class="text-[10px] text-sky-600 font-bold uppercase tracking-widest">Resumen de Ejecución Integral</p>
                    </div>

                    <div class="grid grid-cols-3 gap-4 border-y py-6">
                        <div class="text-center">
                            <span class="report-label block mb-1">Estabilidad</span>
                            <span class="text-xl font-black">${Math.round((eD/eT)*100)}%</span>
                        </div>
                        <div class="text-center">
                            <span class="report-label block mb-1">Flujo</span>
                            <span class="text-xl font-black">${Math.round((fD/fT)*100)}%</span>
                        </div>
                        <div class="text-center">
                            <span class="report-label block mb-1">Sentido</span>
                            <span class="text-xl font-black">${Math.round((sD/sT)*100)}%</span>
                        </div>
                    </div>

                    <section class="space-y-4">
                        <h4 class="report-label">Pilares de Propósito</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-xl border">
                                <span class="report-label opacity-50 block mb-2">Lo que amas</span>
                                <p class="text-[11px] leading-relaxed text-slate-700">${window.localState.ikigaiNotes.love || 'Sin registro.'}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border">
                                <span class="report-label opacity-50 block mb-2">Mundo necesita</span>
                                <p class="text-[11px] leading-relaxed text-slate-700">${window.localState.ikigaiNotes.need || 'Sin registro.'}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border">
                                <span class="report-label opacity-50 block mb-2">Remuneración</span>
                                <p class="text-[11px] leading-relaxed text-slate-700">${window.localState.ikigaiNotes.paid || 'Sin registro.'}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border">
                                <span class="report-label opacity-50 block mb-2">Habilidades</span>
                                <p class="text-[11px] leading-relaxed text-slate-700">${window.localState.ikigaiNotes.good || 'Sin registro.'}</p>
                            </div>
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h4 class="report-label">Auditoría de Tareas (14 Días)</h4>
                        <div class="space-y-6">
                            ${window.plan.map((day, dIdx) => {
                                const dayDone = window.localState.completedDays.includes(day.day);
                                return `
                                    <div class="border-l-2 border-slate-200 pl-4 py-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-[10px] font-black italic uppercase">Día ${day.day} ${dayDone ? '✅' : '(Pendiente)'}</span>
                                        </div>
                                        <div class="space-y-2">
                                            ${day.tasks.map(t => `
                                                <div class="flex justify-between items-center text-[10px]">
                                                    <span class="${t.done ? 'text-emerald-600 font-bold' : 'text-slate-400'}">${t.title} - ${t.concept}</span>
                                                    <span class="text-[8px] font-mono">${t.steps.filter(s=>s.done).length}/${t.steps.length}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h4 class="report-label">Bitácora de Reflexiones</h4>
                        <div class="space-y-3">
                            ${window.localState.reflections.length ? window.localState.reflections.map(r => `
                                <div class="bg-slate-50 p-3 rounded-xl border text-[10px]">
                                    <div class="flex justify-between mb-1 opacity-50 font-bold">
                                        <span>DÍA ${r.day}</span>
                                        <span>${r.ts}</span>
                                    </div>
                                    <p class="text-slate-700">${r.text}</p>
                                </div>
                            `).join('') : '<p class="text-[10px] text-slate-400 italic">No hay registros en la bitácora.</p>'}
                        </div>
                    </section>
                </div>
            `;

            container.innerHTML = html;
            document.getElementById('reportModal').classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('radarChart');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ESTABILIDAD', 'FLUJO', 'SENTIDO'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderColor: '#38bdf8',
                        borderWidth: 2,
                        pointBackgroundColor: '#38bdf8'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            min: 0, max: 100, ticks: { display: false },
                            grid: { color: '#1e293b' },
                            angleLines: { color: '#1e293b' },
                            pointLabels: { color: '#94a3b8', font: { size: 8, weight: 'bold' } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        });
    </script>
</body>
</html>
