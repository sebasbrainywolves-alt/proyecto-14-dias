<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación Ikigai - Sebas Brainy Wolves</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ikigai-brainy-wolves-v4';
        
        window.localState = {
            currentDay: 1,
            completedDays: [],
            reflections: [],
            taskStates: [],
            ikigaiNotes: { love: "", need: "", paid: "", good: "" }
        };

        let db = null, auth = null, currentUser = null;
        let isViewMode = false;

        // --- Lógica de compartir ---
        window.generarLinkCompartido = () => {
            if (!currentUser && !isViewMode) {
                window.showToast("No se detecta usuario activo.", "error");
                return;
            }
            const token = "BRAINY2026";
            const uid = currentUser?.uid || new URLSearchParams(window.location.search).get('view');
            const baseUrl = window.location.origin + window.location.pathname;
            const link = `${baseUrl}?view=${uid}&token=${token}`;

            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            window.showToast("¡Link de progreso copiado!", "success");
        };

        window.showToast = (msg, type) => {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest z-[200] transition-all shadow-2xl ${type === 'success' ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        };

        const loadFromLocalStorage = () => {
            const saved = localStorage.getItem(`ikigai_v4_${appId}`);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    window.localState = { ...window.localState, ...parsed };
                    syncTasksWithState();
                } catch (e) { console.error("Error localStorage", e); }
            }
        };

        const syncTasksWithState = () => {
            if (window.localState.taskStates && Array.isArray(window.localState.taskStates)) {
                window.localState.taskStates.forEach((dayTasks, dIdx) => {
                    if (window.plan && window.plan[dIdx] && Array.isArray(dayTasks)) {
                        dayTasks.forEach((taskData, tIdx) => {
                            if (window.plan[dIdx].tasks[tIdx]) {
                                if (typeof taskData === 'object' && taskData.steps) {
                                    window.plan[dIdx].tasks[tIdx].steps.forEach((step, sIdx) => {
                                        if (taskData.steps[sIdx] !== undefined) step.done = taskData.steps[sIdx];
                                    });
                                    window.plan[dIdx].tasks[tIdx].done = taskData.done;
                                }
                            }
                        });
                    }
                });
            }
        };

        const initFirebase = async () => {
            const params = new URLSearchParams(window.location.search);
            const viewUid = params.get('view');
            const token = params.get('token');
            
            // Modo Observador habilitado si hay token correcto
            if (viewUid && token === "BRAINY2026") {
                isViewMode = true;
                document.body.classList.add('view-only-mode');
            } else {
                loadFromLocalStorage(); 
            }

            window.updateUI();
            window.renderReflections();

            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                    } else { 
                        await signInAnonymously(auth); 
                    }

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                            const targetUid = isViewMode ? viewUid : user.uid;
                            
                            const userIdElem = document.getElementById('userIdDisplay');
                            if(userIdElem) userIdElem.innerText = isViewMode ? `MODO OBSERVADOR: ${targetUid.substring(0,8)}` : `ID: ${user.uid}`;
                            
                            const docRef = doc(db, 'artifacts', appId, 'users', targetUid, 'progress', 'mainState');
                            onSnapshot(docRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    let data = docSnap.data();
                                    if (data.taskStates && typeof data.taskStates === 'string') {
                                        data.taskStates = JSON.parse(data.taskStates);
                                    }
                                    window.localState = { ...window.localState, ...data };
                                    syncTasksWithState();
                                    window.updateUI();
                                    window.renderReflections();
                                    updateIkigaiFields();
                                }
                            }, (error) => console.error("Firestore Error:", error));
                        }
                        const overlay = document.getElementById('loadingOverlay');
                        if(overlay) overlay.style.display = 'none';
                    });
                } else {
                    const overlay = document.getElementById('loadingOverlay');
                    if(overlay) overlay.style.display = 'none';
                }
            } catch (err) { 
                const overlay = document.getElementById('loadingOverlay');
                if(overlay) overlay.style.display = 'none';
            }
        };

        const updateIkigaiFields = () => {
            const notes = window.localState.ikigaiNotes || {};
            if(document.getElementById('noteLove')) document.getElementById('noteLove').value = notes.love || "";
            if(document.getElementById('noteNeed')) document.getElementById('noteNeed').value = notes.need || "";
            if(document.getElementById('notePaid')) document.getElementById('notePaid').value = notes.paid || "";
            if(document.getElementById('noteGood')) document.getElementById('noteGood').value = notes.good || "";
        };

        window.saveData = async () => {
            if (isViewMode) return; // No guardar si solo estamos viendo

            const states = window.plan.map(p => p.tasks.map(t => ({
                done: t.done,
                steps: t.steps.map(s => s.done)
            })));
            window.localState.taskStates = states;
            
            window.localState.ikigaiNotes = {
                love: document.getElementById('noteLove')?.value || "",
                need: document.getElementById('noteNeed')?.value || "",
                paid: document.getElementById('notePaid')?.value || "",
                good: document.getElementById('noteGood')?.value || ""
            };

            localStorage.setItem(`ikigai_v4_${appId}`, JSON.stringify(window.localState));
            
            if (currentUser && db) {
                const dataToSave = { 
                    ...window.localState, 
                    taskStates: JSON.stringify(states),
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'progress', 'mainState'), dataToSave);
            }
        };

        window.addEventListener('load', initFirebase);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --bg: #0b1120; --card: #161e31; --accent: #38bdf8; --success: #10b981; }
        body { background-color: var(--bg); color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass-card { background: var(--card); border: 1px solid #1e293b; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { border-color: #334155; transform: translateY(-2px); }
        .day-box { aspect-ratio: 1/1; border-radius: 12px; border: 1px solid #1e293b; cursor: pointer; transition: all 0.2s; min-width: 40px; }
        .day-box.completed { border-color: var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .day-box.current { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); transform: scale(1.05); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        .task-card { border-left: 4px solid #1e293b; }
        .task-card.done { border-left-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .step-item { cursor: pointer; }
        .step-item.checked { color: var(--success); text-decoration: line-through; opacity: 0.6; }
        .ikigai-input { background: transparent; border: none; border-bottom: 1px solid #1e293b; width: 100%; font-size: 11px; color: #94a3b8; outline: none; transition: 0.3s; }
        .ikigai-input:focus { border-color: var(--accent); color: white; }
        
        .modal-backdrop { background: rgba(0,0,0,0.9); backdrop-filter: blur(12px); }
        .report-label { font-size: 9px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 0.15em; }
        
        /* Modo Observador */
        .view-only-mode textarea, .view-only-mode button:not(#closeReport):not(#shareReportBtn) { pointer-events: none; opacity: 0.7; }
        .view-only-mode .day-box { pointer-events: auto; opacity: 1; }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); }
        }
        .pulse { animation: heartbeat 2s ease-in-out infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen pb-20 p-4 md:p-8">

    <div id="toast" style="display:none"></div>

    <div id="loadingOverlay" class="fixed inset-0 bg-[#0b1120] z-50 flex items-center justify-center text-center">
        <div>
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-sky-500 mb-4 mx-auto"></div>
            <p class="text-[10px] font-bold tracking-widest text-slate-500 uppercase italic">Iniciando Dashboard Sebas Brainy Wolves...</p>
        </div>
    </div>

    <!-- Modal Reporte Integral -->
    <div id="reportModal" class="fixed inset-0 z-[100] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-slate-900 font-black italic uppercase text-lg tracking-tighter">Reporte Integral <span class="text-sky-600">Ikigai-Kaizen</span></h3>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">SISTEMA DE CONTROL PROCESO C • BRAINY WOLVES</p>
                </div>
                <div class="flex gap-2">
                    <button id="shareReportBtn" onclick="window.generarLinkCompartido()" class="bg-sky-500 text-white hover:bg-sky-600 p-3 rounded-full px-6 text-[10px] font-bold uppercase transition-all">Copiar Link Público</button>
                    <button id="closeReport" onclick="document.getElementById('reportModal').classList.add('hidden')" class="bg-slate-900 text-white hover:bg-black p-3 rounded-full px-6 text-[10px] font-bold uppercase transition-all">Cerrar</button>
                </div>
            </div>
            <div id="reportContent" class="overflow-y-auto p-8 md:p-16 bg-white text-slate-800">
                <!-- Generado dinámicamente -->
            </div>
            <div class="p-6 bg-slate-900 text-center">
                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Este documento es propiedad de Sebas Brainy Wolves - 2026</p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-sky-500 rounded-2xl flex items-center justify-center shadow-lg shadow-sky-500/20 pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic uppercase tracking-tighter leading-none">SEBAS <span class="text-sky-400">BRAINY WOLVES</span></h1>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-1">OPERATIONAL CONTROL DASHBOARD • IKIGAI v4.0</p>
                </div>
            </div>
            <div id="userIdDisplay" class="text-[9px] font-mono text-slate-500 bg-slate-900 border border-slate-800 px-4 py-2 rounded-xl uppercase">Sincronizando...</div>
        </header>

        <!-- Pilares de Propósito -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card rounded-3xl p-5 border-t-2 border-pink-500/30">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-2 h-2 rounded-full bg-pink-500"></div>
                    <h4 class="text-[10px] font-black uppercase text-pink-400 tracking-wider">Lo que amas</h4>
                </div>
                <textarea id="noteLove" onblur="window.saveData()" class="ikigai-input h-14 resize-none" placeholder="Pasiones, hobbies, disfrute..."></textarea>
            </div>
            <div class="glass-card rounded-3xl p-5 border-t-2 border-indigo-500/30">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                    <h4 class="text-[10px] font-black uppercase text-indigo-400 tracking-wider">Mundo necesita</h4>
                </div>
                <textarea id="noteNeed" onblur="window.saveData()" class="ikigai-input h-14 resize-none" placeholder="Problemas a resolver..."></textarea>
            </div>
            <div class="glass-card rounded-3xl p-5 border-t-2 border-emerald-500/30">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                    <h4 class="text-[10px] font-black uppercase text-emerald-400 tracking-wider">Remuneración</h4>
                </div>
                <textarea id="notePaid" onblur="window.saveData()" class="ikigai-input h-14 resize-none" placeholder="Viabilidad económica..."></textarea>
            </div>
            <div class="glass-card rounded-3xl p-5 border-t-2 border-amber-500/30">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                    <h4 class="text-[10px] font-black uppercase text-amber-400 tracking-wider">Tus fortalezas</h4>
                </div>
                <textarea id="noteGood" onblur="window.saveData()" class="ikigai-input h-14 resize-none" placeholder="Habilidades, talentos..."></textarea>
            </div>
        </div>

        <!-- Métricas KPI -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-[9px] font-bold text-slate-500 uppercase mb-1">Ejecución Total</div>
                    <div id="percGlobal" class="text-4xl font-black italic">0%</div>
                </div>
                <div class="absolute -right-4 -bottom-4 opacity-5">
                    <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                </div>
            </div>
            <div class="glass-card rounded-3xl p-6 border-b-4 border-sky-500/20">
                <div class="text-[9px] font-bold text-slate-500 uppercase mb-1">Estabilidad</div>
                <div id="percEst" class="text-3xl font-black text-sky-400">0%</div>
            </div>
            <div class="glass-card rounded-3xl p-6 border-b-4 border-amber-500/20">
                <div class="text-[9px] font-bold text-slate-500 uppercase mb-1">Flujo</div>
                <div id="percFlu" class="text-3xl font-black text-amber-400">0%</div>
            </div>
            <div class="glass-card rounded-3xl p-6 border-b-4 border-emerald-500/20">
                <div class="text-[9px] font-bold text-slate-500 uppercase mb-1">Sentido</div>
                <div id="percSen" class="text-3xl font-black text-emerald-400">0%</div>
            </div>
        </div>

        <div id="calendarGrid" class="flex overflow-x-auto pb-6 gap-2 no-scrollbar mb-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Feed de Tareas -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h2 id="dayTitle" class="text-4xl font-black italic tracking-tighter uppercase">Día 1</h2>
                        <p id="dayContext" class="text-[10px] font-bold text-slate-500 uppercase mt-1">Auditando objetivos actuales</p>
                    </div>
                    <span id="dailyCount" class="text-xs font-mono font-bold text-sky-400 bg-sky-400/10 px-4 py-2 rounded-xl border border-sky-400/20">0 / 0</span>
                </div>
                
                <div id="taskList" class="grid grid-cols-1 md:grid-cols-1 gap-4"></div>
                
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button onclick="window.cerrarDia()" class="group relative bg-sky-600 hover:bg-sky-500 text-white font-black py-5 rounded-[1.5rem] transition-all overflow-hidden uppercase text-[11px] tracking-widest italic active:scale-[0.98]">
                        <span class="relative z-10">Marcar Jornada Completa</span>
                        <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                    </button>
                    <button onclick="window.generarReporte()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 font-black py-5 rounded-[1.5rem] transition-all uppercase text-[11px] tracking-widest italic border border-slate-700 active:scale-[0.98]">
                        Exportar Reporte Integral
                    </button>
                </div>
            </div>

            <!-- Analítica y Bitácora -->
            <div class="space-y-6">
                <div class="glass-card rounded-[2rem] p-8 shadow-2xl">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-6 tracking-widest text-center">Firma de Rendimiento</h3>
                    <canvas id="radarChart"></canvas>
                </div>
                
                <div class="glass-card rounded-[2rem] p-8">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest flex items-center gap-2">
                        <svg class="w-3 h-3 text-sky-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        Bitácora Kaizen
                    </h3>
                    <textarea id="reflexionInput" class="w-full bg-slate-900 border border-slate-800 rounded-2xl p-4 text-xs mb-4 focus:ring-2 focus:ring-sky-500/50 outline-none text-slate-300 min-h-[100px]" placeholder="¿Qué aprendiste hoy? Hallazgos clave..."></textarea>
                    <button onclick="window.guardarReflexion()" class="w-full bg-sky-500/10 hover:bg-sky-500/20 text-sky-400 font-bold py-3 rounded-xl text-[10px] uppercase tracking-widest transition-all">Registrar Nota Técnica</button>
                    <div id="historyLog" class="mt-6 space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const rawPlan = [
            { day: 1, context: "Auditando objetivos actuales", tasks: [
                { concept: "Estabilidad", title: "Carpeta Digital Master", steps: ["Estructura Drive", "Configuración permisos", "Validación nomenclatura"] },
                { concept: "Flujo", title: "Registro Sebastián", steps: ["Copia digital documentos", "Validación de versiones", "Subida a repositorio"] },
                { concept: "Sentido", title: "Foto: Luz Natural", steps: ["Encuadre potencial", "Captura lumínica", "Nota de percepción"] }
            ]},
            { day: 2, context: "Mapeo de prioridades", tasks: [
                { concept: "Estabilidad", title: "Registro Ana", steps: ["Escaneo alta calidad", "Centralización Drive", "Checklist legal"] },
                { concept: "Flujo", title: "Preparación Cota", steps: ["Mapeo de grietas", "Marcación técnica", "Fotos de estado inicial"] },
                { concept: "Sentido", title: "Foto: Textura", steps: ["Selección material bruto", "Captura detalle", "Registro táctil"] }
            ]},
            { day: 3, context: "Optimización de procesos", tasks: [
                { concept: "Estabilidad", title: "Migración Digital", steps: ["Renombrar archivos", "Limpieza de duplicados", "Back-up seguridad"] },
                { concept: "Flujo", title: "Seguimiento Legal", steps: ["Revisión bandeja entrada", "Redacción seguimiento", "Confirmación de envío"] },
                { concept: "Sentido", title: "Dibujo Observación", steps: ["Elección de rincón", "Boceto estructural", "Reflexión espacial"] }
            ]},
            { day: 4, context: "Acción material inmediata", tasks: [
                { concept: "Estabilidad", title: "Finalizar Resane", steps: ["Preparación mezcla", "Aplicación segunda capa", "Verificación nivel"] },
                { concept: "Flujo", title: "Inventario Táctico", steps: ["Conteo latas pintura", "Clasificación colores", "Actualización excel stock"] },
                { concept: "Sentido", title: "Registro 'Antes'", steps: ["Foto panorámica 1", "Ajuste de exposición", "Guardar referencia"] }
            ]},
            { day: 5, context: "Estructura y detalle", tasks: [
                { concept: "Estabilidad", title: "Medición Vidrios", steps: ["Toma de dimensiones", "Dibujo de croquis", "Cálculo de áreas"] },
                { concept: "Flujo", title: "Orden Herramientas", steps: ["Clasificación por tipo", "Limpieza de equipos", "Organización vertical"] },
                { concept: "Sentido", title: "Composición Ikigai", steps: ["Elección 3 objetos", "Foto composición", "Nota filosófica"] }
            ]},
            { day: 6, context: "Protección y blindaje", tasks: [
                { concept: "Estabilidad", title: "Impermeabilización", steps: ["Identificación focos", "Aplicación sellador", "Test de absorción"] },
                { concept: "Flujo", title: "Validación Agenda", steps: ["Revisión citas", "Confirmación técnicos", "Bloqueo de horario"] },
                { concept: "Sentido", title: "Foto de Manos", steps: ["Captura esfuerzo", "Registro manual", "Nota de orgullo"] }
            ]},
            { day: 7, context: "Transformación visual", tasks: [
                { concept: "Estabilidad", title: "Base de Color", steps: ["Preparación superficie", "Aplicación primera mano", "Control de goteo"] },
                { concept: "Flujo", title: "Limpieza Operativa", steps: ["Retiro de escombros", "Eliminación polvo", "Orden de insumos"] },
                { concept: "Sentido", title: "Bitácora de Cambio", steps: ["Relato nuevo color", "Foto de transición", "Reflexión emocional"] }
            ]},
            { day: 8, context: "Consolidación estética", tasks: [
                { concept: "Estabilidad", title: "Acabado Uniforme", steps: ["Segunda mano pintura", "Retoque bordes", "Verificación brillo"] },
                { concept: "Flujo", title: "Auditoría Legal II", steps: ["Revisión documentos", "Actualización estatus", "Archivador físico/dig"] },
                { concept: "Sentido", title: "Trazos Libres", steps: ["Dibujo espontáneo", "Nota de flujo", "Registro gráfico"] }
            ]},
            { day: 9, context: "Revelado y curaduría", tasks: [
                { concept: "Estabilidad", title: "Retiro Protecciones", steps: ["Remoción cintas", "Limpieza vidrios", "Revelado final"] },
                { concept: "Flujo", title: "Curaduría Visual", steps: ["Selección 10 fotos", "Edición básica", "Organización portafolio"] },
                { concept: "Sentido", title: "Foto 'Después'", steps: ["Réplica ángulo 'Antes'", "Captura final", "Comparativa visual"] }
            ]},
            { day: 10, context: "Proyección estratégica", tasks: [
                { concept: "Estabilidad", title: "Borrador de Oferta", steps: ["Definición canon", "Redacción términos", "Revisión ortográfica"] },
                { concept: "Flujo", title: "Estudio de Mercado", steps: ["Benchmarking zona", "Matriz comparativa", "Proyección rentabilidad"] },
                { concept: "Sentido", title: "Captura Ambiente", steps: ["Foto detalle hogar", "Nota atmósfera", "Registro calidez"] }
            ]},
            { day: 11, context: "Lanzamiento y gestión", tasks: [
                { concept: "Estabilidad", title: "Publicación Oficial", steps: ["Subida portales", "Redacción copy", "Gestión destacados"] },
                { concept: "Flujo", title: "Atención Táctica", steps: ["Gestión mensajes", "Agendar visitas", "Checklist interesados"] },
                { concept: "Sentido", title: "Dibujo de Habitante", steps: ["Boceto perfil ideal", "Nota de conexión", "Registro mental"] }
            ]},
            { day: 12, context: "Cierre de ciclos", tasks: [
                { concept: "Estabilidad", title: "Presión Legal", steps: ["Llamada abogado", "Estatus proceso", "Nota de seguimiento"] },
                { concept: "Flujo", title: "Cierre de Gastos", steps: ["Conciliación facturas", "Balance inversión", "Nota rentabilidad"] },
                { concept: "Sentido", title: "Foto: Apertura", steps: ["Captura ventana/luz", "Encuadre futuro", "Registro apertura"] }
            ]},
            { day: 13, context: "Validación externa", tasks: [
                { concept: "Estabilidad", title: "Segunda Opinión", steps: ["Consulta externa", "Visita técnica", "Consolidado técnico"] },
                { concept: "Flujo", title: "Matriz de Interés", steps: ["Evaluación candidatos", "Elección top 3", "Llamadas filtrado"] },
                { concept: "Sentido", title: "Círculo Enso", steps: ["Práctica dibujo", "Meditación proyecto", "Registro espiritual"] }
            ]},
            { day: 14, context: "Auditoría final y Kaizen", tasks: [
                { concept: "Estabilidad", title: "Auditoría de Bloques", steps: ["Revisión 14 días", "Cierre técnicos", "Análisis de fallos"] },
                { concept: "Flujo", title: "Plan Siguiente Ciclo", steps: ["Definición metas mes", "Calendario operativo", "Diseño Kaizen"] },
                { concept: "Sentido", title: "Foto: Gratitud", steps: ["Captura momento", "Nota de cierre", "Registro felicidad"] }
            ]}
        ];

        window.plan = rawPlan.map(d => ({
            ...d,
            tasks: d.tasks.map(t => ({
                ...t, done: false,
                steps: t.steps.map(s => ({ text: s, done: false }))
            }))
        }));

        let radarChartInstance = null;

        window.initRadar = () => {
            const ctx = document.getElementById('radarChart').getContext('2d');
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Estabilidad', 'Flujo', 'Sentido'],
                    datasets: [{
                        label: 'Rendimiento %',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        borderColor: '#38bdf8',
                        borderWidth: 2,
                        pointBackgroundColor: '#38bdf8'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { display: false },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            angleLines: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        window.toggleStep = (dayIdx, taskIdx, stepIdx) => {
            const task = window.plan[dayIdx].tasks[taskIdx];
            task.steps[stepIdx].done = !task.steps[stepIdx].done;
            task.done = task.steps.every(s => s.done);
            window.updateUI();
            window.saveData();
        };

        window.updateUI = () => {
            const dayIdx = window.localState.currentDay - 1;
            const currentPlan = window.plan[dayIdx];
            document.getElementById('dayTitle').innerText = `Día ${currentPlan.day}`;
            document.getElementById('dayContext').innerText = currentPlan.context;
            
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            let tSteps = 0, cSteps = 0;

            currentPlan.tasks.forEach((t, i) => {
                const card = document.createElement('div');
                card.className = `task-card glass-card rounded-3xl p-6 ${t.done ? 'done' : ''}`;
                
                let sHtml = '';
                t.steps.forEach((s, si) => {
                    tSteps++; if(s.done) cSteps++;
                    sHtml += `
                        <div onclick="window.toggleStep(${dayIdx}, ${i}, ${si})" class="step-item flex items-center p-3 rounded-xl hover:bg-white/5 transition-all ${s.done ? 'checked' : 'text-slate-400'}">
                            <div class="w-5 h-5 rounded-lg border-2 border-slate-700 mr-4 flex items-center justify-center transition-all ${s.done ? 'bg-emerald-500 border-emerald-500' : 'bg-slate-900'}">
                                ${s.done ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>' : ''}
                            </div>
                            <span class="text-[11px] font-bold uppercase tracking-tight">${s.text}</span>
                        </div>`;
                });

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[9px] font-black uppercase px-2 py-1 bg-sky-500/10 text-sky-400 rounded-md tracking-widest">${t.concept}</span>
                            <h4 class="text-lg font-black text-white mt-2 italic">${t.title}</h4>
                        </div>
                        <div class="text-[10px] font-mono font-bold text-slate-500 bg-slate-900 px-3 py-1 rounded-full border border-slate-800">
                            ${t.steps.filter(s => s.done).length}/${t.steps.length} STEPS
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-1 border-t border-slate-800 pt-4">${sHtml}</div>`;
                taskList.appendChild(card);
            });

            document.getElementById('dailyCount').innerText = `${cSteps} / ${tSteps} OBJETIVOS`;

            let allT=0, allD=0, eT=0, eD=0, fT=0, fD=0, sT=0, sD=0;
            window.plan.forEach(d => d.tasks.forEach(t => {
                t.steps.forEach(s => {
                    allT++; if(s.done) allD++;
                    if(t.concept === "Estabilidad") { eT++; if(s.done) eD++; }
                    if(t.concept === "Flujo") { fT++; if(s.done) fD++; }
                    if(t.concept === "Sentido") { sT++; if(s.done) sD++; }
                });
            }));

            const pG = Math.round((allD/allT)*100) || 0;
            const pE = Math.round((eD/eT)*100) || 0;
            const pF = Math.round((fD/fT)*100) || 0;
            const pS = Math.round((sD/sT)*100) || 0;
            
            document.getElementById('percGlobal').innerText = pG + "%";
            document.getElementById('percEst').innerText = pE + "%";
            document.getElementById('percFlu').innerText = pF + "%";
            document.getElementById('percSen').innerText = pS + "%";
            
            if(radarChartInstance) {
                radarChartInstance.data.datasets[0].data = [pE, pF, pS];
                radarChartInstance.update();
            }

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            for(let i=1; i<=14; i++) {
                const div = document.createElement('div');
                const isDone = window.localState.completedDays.includes(i);
                div.className = `day-box flex flex-col items-center justify-center text-[11px] font-black p-4 min-w-[70px] ${i === window.localState.currentDay ? 'current' : ''} ${isDone ? 'completed' : 'text-slate-600'}`;
                div.innerHTML = `<span class="text-[7px] uppercase mb-1 opacity-50">Día</span><span>${i}</span>`;
                div.onclick = () => { window.localState.currentDay = i; window.updateUI(); };
                grid.appendChild(div);
            }
        };

        window.cerrarDia = () => {
            if(!window.localState.completedDays.includes(window.localState.currentDay)) {
                window.localState.completedDays.push(window.localState.currentDay);
            }
            if(window.localState.currentDay < 14) window.localState.currentDay++;
            window.updateUI();
            window.saveData();
        };

        window.guardarReflexion = () => {
            const val = document.getElementById('reflexionInput').value;
            if(!val.trim()) return;
            window.localState.reflections.push({ 
                day: window.localState.currentDay, 
                text: val, 
                ts: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) 
            });
            document.getElementById('reflexionInput').value = '';
            window.renderReflections();
            window.saveData();
        };

        window.renderReflections = () => {
            const log = document.getElementById('historyLog');
            if(!log) return;
            log.innerHTML = window.localState.reflections.slice().reverse().map(r => `
                <div class="bg-slate-900 border border-slate-800 p-3 rounded-xl">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[8px] font-black text-sky-400 uppercase tracking-widest">Día ${r.day} • ${r.ts}</span>
                    </div>
                    <p class="text-[10px] text-slate-300 leading-relaxed">${r.text}</p>
                </div>
            `).join('');
        };

        window.generarReporte = () => {
            const modal = document.getElementById('reportModal');
            const content = document.getElementById('reportContent');
            modal.classList.remove('hidden');

            const ikigai = window.localState.ikigaiNotes;
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-8 mb-12 border-b pb-8">
                    <div>
                        <div class="report-label">Estado de Propósito</div>
                        <p class="mt-4 text-sm"><strong>Amas:</strong> ${ikigai.love || 'Sin datos'}</p>
                        <p class="text-sm"><strong>Necesidad:</strong> ${ikigai.need || 'Sin datos'}</p>
                        <p class="text-sm"><strong>Paga:</strong> ${ikigai.paid || 'Sin datos'}</p>
                        <p class="text-sm"><strong>Fortalezas:</strong> ${ikigai.good || 'Sin datos'}</p>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-200">
                        <div class="report-label">Kpis Actuales</div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Ejecución</p>
                                <p class="text-2xl font-black">${document.getElementById('percGlobal').innerText}</p>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Estabilidad</p>
                                <p class="text-2xl font-black">${document.getElementById('percEst').innerText}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-12">
                    <div class="report-label mb-6">Bitácora Kaizen (Últimas Notas)</div>
                    <div class="space-y-4">
                        ${window.localState.reflections.length > 0 ? 
                            window.localState.reflections.slice(-5).map(r => `
                                <div class="border-l-2 border-sky-200 pl-4 py-1">
                                    <p class="text-[8px] font-black uppercase text-slate-400">Día ${r.day} | ${r.ts}</p>
                                    <p class="text-sm text-slate-600 italic">"${r.text}"</p>
                                </div>
                            `).join('') : '<p class="text-slate-400 italic">No hay registros de bitácora.</p>'
                        }
                    </div>
                </div>

                <div>
                    <div class="report-label mb-6">Matriz de Cumplimiento (14 Días)</div>
                    <div class="grid grid-cols-7 gap-2">
                        ${Array.from({length: 14}, (_, i) => {
                            const d = i + 1;
                            const done = window.localState.completedDays.includes(d);
                            return `<div class="p-2 border text-center rounded-lg ${done ? 'bg-emerald-50 border-emerald-100' : 'bg-slate-50 border-slate-100 text-slate-300'}">
                                <span class="text-[8px] block font-black">D${d}</span>
                                <span class="text-[10px]">${done ? '✓' : '—'}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        window.onload = () => {
            window.initRadar();
            window.updateUI();
        }
    </script>
</body>
</html>
